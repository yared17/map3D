<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Map 3D</title>
  <link rel="icon" type="image/png" sizes="64x64" href="assets/img/plogo.ico">
  <script src="https://unpkg.com/globe.gl"></script>

  <style>
    :root{
      --bg:#0b1320; --panel:#0f1a30; --text:#e6eefc; --muted:#a9b7d0;
      --accent:#4cc9f0; --selected:#80ffdb; --equiv:#ffd166; --border:#21324f;
      --vh: 1vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui, Segoe UI, Roboto, Inter, Arial;
      -webkit-tap-highlight-color: transparent;
    }
    #app{
      display:grid;
      grid-template-columns:340px 1fr;
      grid-template-rows:auto 1fr;
      gap:10px;
      height:calc(var(--vh) * 100);
      padding:10px;
      padding-top: calc(10px + var(--safe-top));
      padding-bottom: calc(10px + var(--safe-bottom));
    }
    header{
      grid-column:1/3;
      background:linear-gradient(90deg, rgba(76,201,240,.12), rgba(100,223,223,.04));
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    header h1{margin:0;font-size:18px;font-weight:700}
    .pill,button,select{
      background:var(--panel); color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    button:hover, select:hover{border-color:var(--accent); box-shadow:0 0 0 3px rgba(76,201,240,.12)}
    #statusPill{font-size:13px; opacity:.9}

    #sidebar{
      grid-row:2; grid-column:1;
      background:var(--panel); border:1px solid var(--border); border-radius:14px;
      padding:14px; display:flex; flex-direction:column; gap:10px; min-height:0;
    }
    #info{background:rgba(255,255,255,.03); border:1px dashed var(--border); border-radius:12px; padding:10px}
    .stat{display:grid; grid-template-columns:1fr auto; gap:6px; font-size:14px}
    .stat .val{font-weight:700; color:var(--accent)}
    #legend{display:flex; gap:8px; flex-wrap:wrap}
    .legend-item{display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--border); border-radius:10px; background:rgba(255,255,255,.03); font-size:13px}
    .sw{width:14px; height:14px; border-radius:3px; border:1px solid #0003}
    .sw.sel{background:var(--selected)} .sw.eq{background:var(--equiv)} .sw.base{background:#6b7280}

    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size: 15px;}

    /* Lista principal */
    #countriesList{
      overflow:auto; flex:1;
      border:1px solid var(--border); border-radius:12px; padding:8px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    #countriesList .section{padding:6px 10px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px;}
    #countriesList .item{display:flex; justify-content:space-between; gap:8px; padding:8px 10px; border-bottom:1px dashed var(--border); font-size:14px; color:var(--muted)}
    #countriesList .item strong{color:var(--text)}
    #countriesList .tag{font-size:12px; opacity:.8}

    /* Contenedor globo */
    #globeWrap{
      grid-row:2; grid-column:2;
      border:1px solid var(--border); border-radius:14px; position:relative; min-height:0; background:#000;
      touch-action: pan-y;
    }
    #globe{position:absolute; inset:0}

    /* Toggle de modo */
    .mode-toggle{display:flex; gap:6px; background:rgba(255,255,255,.03); padding:6px; border:1px solid var(--border); border-radius:10px;}
    .mode-toggle button{flex:1}
    .active{border-color:var(--accent); box-shadow:0 0 0 3px rgba(76,201,240,.12)}

    .hint{color:var(--muted); font-size:12px; margin-top:-4px}
@media (max-width: 980px){
  #app{ 
    grid-template-columns:1fr; 
    grid-template-rows:auto calc(var(--vh) * 48) 1fr; 
  }
  #sidebar{
    grid-row:3; 
    grid-column:1; 
    padding:12px;
  }
  #statusPill{ 
    display: none !important;
  }
  #globeWrap{
    grid-row:2; 
    grid-column:1;
  }
  .stat{font-size:15px}
  .legend-item{font-size:12px; padding:6px 10px}
  .pill, button, select{padding:12px 16px}
  #countriesList{min-height:0}
  #btnDownload{ display:none !important; }

  /* üîΩ fix header en m√≥vil */
  header .row{
    flex-wrap: wrap;              /* permite varias filas sin huecos */
    justify-content: flex-start;  /* no deja espacio innecesario */
    gap: 8px;
    width: 100%;
  }
  #metricSelect{
    margin-left: auto;            /* lo empuja a la derecha */
    align-self: flex-end;         /* se alinea abajo de su fila */
  }
}


    
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Map 3D</h1>
    <div class="row" style="align-items:center; gap:10px">
      <div class="mode-toggle" title="Modo de c√°lculo">
        <button id="btnModeEq" class="active">Equivalencias</button>
        <button id="btnModeNearest">Parecidos</button>
      </div>
      <div class="metric-group">
        <label for="metricSelect" class="pill" style="background:transparent;border:none;padding:0;font-weight:700">M√©trica:</label>
        <select id="metricSelect" title="Elegir m√©trica para equivalencias o comparaci√≥n">
          <option value="pop" selected>Poblaci√≥n</option>
          <option value="gdp">PIB (USD)</option>
          <option value="gdp_pc">PIB per c√°pita (USD)</option>
        </select>
      </div>


      <button id="btnDownload">Descargar JSON</button>
      <span id="statusPill" class="pill">Listo</span>
    </div>
  </header>

  <aside id="sidebar">
    <div id="info">
      <div class="stat"><span>Pa√≠s seleccionado</span><span class="val" id="selName">‚Äî</span></div>
      <div class="stat"><span id="labelTarget">Objetivo (Poblaci√≥n)</span><span class="val" id="selVal">‚Äî</span></div>
      <div class="stat"><span id="labelSum">Suma equivalente</span><span class="val" id="sumVal">‚Äî</span></div>
      <div class="stat"><span id="labelDiff">Diferencia</span><span class="val" id="diffVal">‚Äî</span></div>
    </div>

    <div id="legend">
      <div class="legend-item"><span class="sw sel"></span>Seleccionado</div>
      <div class="legend-item"><span class="sw eq"></span><span id="legendModeLabel">Equivalentes</span></div>
      <div class="legend-item"><span class="sw base"></span>Otros</div>
    </div>

    <div class="hint" id="hintText">Lista de pa√≠ses equivalentes seg√∫n la m√©trica elegida.</div>
    <div id="countriesList"></div>
  </aside>

  <div id="globeWrap"><div id="globe"></div></div>
</div>

<script>
  /* ========= UTIL ========= */
  const fmtPop = new Intl.NumberFormat('es-CO'); // poblaci√≥n
  const fmtUSD  = new Intl.NumberFormat('es-CO', { style:'currency', currency:'USD', maximumFractionDigits:0 });
  const $ = id => document.getElementById(id);
  const setStatus = (msg) => { const el = $('statusPill'); if (el) el.textContent = msg; };

  function setVHVar(){
    const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--vh', `${vh/100}px`);
  }
  setVHVar();
  window.addEventListener('resize', setVHVar);
  window.addEventListener('orientationchange', setVHVar);

  // Estado
  let globe, features = [], allCountries = []; // {iso3, name, pop, gdp, gdp_pc}
  let selectedISO3 = null;
  const equivalentsISO3 = new Set();
  const metricSelect = $('metricSelect');

  // Nuevo estado de modo y nearest
  let mode = 'equiv'; // 'equiv' | 'nearest'
  let nearestCombinedISO3 = null; // resaltado dorado en modo 'nearest'

  // Pesos para combinado (por defecto)
  const WEIGHTS_DEFAULT = { pop: 0.5, gdp: 0.3, gdp_pc: 0.2 };

  // m√©trica
  function labelForMetric(m){
    if (m==='gdp') return 'Objetivo (PIB USD)';
    if (m==='gdp_pc') return 'Objetivo (PIB per c√°pita USD)';
    return 'Objetivo (Poblaci√≥n)';
  }
  function formatByMetric(m, v){
    if (v==null || !isFinite(v)) return '‚Äî';
    if (m==='pop') return fmtPop.format(v);
    return fmtUSD.format(v);
  }
  function valueForCountryByMetric(c, m){
    if (m==='gdp') return c.gdp ?? null;
    if (m==='gdp_pc') return c.gdp_pc ?? null;
    return c.pop ?? null;
  }

  /* ========= CARGA GEO ========= */
  async function loadWorldGeo(){
    const url = 'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson';
    const geo = await fetch(url, {mode:'cors'}).then(r=>r.json());
    const arr = geo.features;
    arr.forEach(f=>{
      const p = f.properties || {};
      p.name = p.name || p.ADMIN || p.NAME || p.name_long || p.sovereignt || 'Pa√≠s';
      p.iso3 = String(p.ISO_A3 || p.ADM0_A3 || p.iso_a3 || f.id || '').toUpperCase().replace(/[^A-Z]/g,'');
      f.properties = p;
    });
    return arr;
  }

  /* ========= CARGA POBLACI√ìN ========= */
  async function loadPopulation(){
    const cache = localStorage.getItem('world_pop_v1');
    if (cache){ allCountries = JSON.parse(cache); return {source:'cache'}; }
    const data = await fetch('https://restcountries.com/v3.1/all?fields=name,cca3,population').then(r=>r.json());
    allCountries = data.filter(d=>d?.name?.common && Number.isFinite(d.population))
                       .map(d=>({ iso3:String(d.cca3).toUpperCase(), name:d.name.common, pop:d.population }));
    localStorage.setItem('world_pop_v1', JSON.stringify(allCountries));
    return {source:'api'};
  }

  /* ========= CARGA ECON√ìMICA (Banco Mundial) ========= */
  async function loadWBIndicator(indicator){
    const url = `https://api.worldbank.org/v2/country/all/indicator/${indicator}?format=json&per_page=20000`;
    const json = await fetch(url).then(r=>r.json());
    const series = json?.[1] || [];
    const latestByIso = new Map(); // iso3 -> {year, value}
    for (const row of series){
      const iso3 = row?.countryiso3code?.toUpperCase?.();
      const val = row?.value;
      const year = Number(row?.date);
      if (!iso3) continue;
      if (val==null) continue;
      const prev = latestByIso.get(iso3);
      if (!prev || year > prev.year){
        latestByIso.set(iso3, {year, value: Number(val) });
      }
    }
    return latestByIso;
  }

  async function loadEconomics(){
    setStatus('Cargando econom√≠a (PIB, PIB per c√°pita)‚Ä¶');

    const [gdpMap, gdpPcMap] = await Promise.all([
      loadWBIndicator('NY.GDP.MKTP.CD'),
      loadWBIndicator('NY.GDP.PCAP.CD')
    ]);

    // Partimos SOLO de pa√≠ses reales (restcountries) como base autoritativa
    const byIso = new Map(allCountries.map(c => [c.iso3, c]));

    // Aplica indicador S√ìLO si el ISO existe en la base (ignora agregados/regiones WB)
    const applyIfCountry = (map, field) => {
      for (const [iso3, rec] of map) {
        const c = byIso.get(iso3);
        if (!c) continue;
        c[field] = rec.value;
      }
    };

    applyIfCountry(gdpMap, 'gdp');
    applyIfCountry(gdpPcMap, 'gdp_pc');

    // Volvemos al array (sin regiones/aggregates)
    allCountries = Array.from(byIso.values());

    setStatus('Econom√≠a cargada');
  }

  /* ========= EQUIVALENCIAS (suma) ========= */
  function findApproxCombination(items, target, {tries=350, tolerance=0.02, accessFn}={}){
    let best = { diff: Infinity, set: [] };
    const maxSum = target*(1+tolerance);
    for (let t=0;t<tries;t++){
      const offset = Math.floor(Math.random()*Math.min(20, items.length));
      const takeProbBias = 0.85;
      let sum=0, chosen=[];
      for (let i=0;i<items.length;i++){
        const it = items[(i+offset)%items.length];
        const v = accessFn(it);
        if (v==null || !isFinite(v)) continue;
        if (sum+v<=maxSum){
          const ratio = sum/target;
          const p = ratio<0.5?1:(ratio<0.8?takeProbBias:0.5);
          if (Math.random()<p){ chosen.push(it); sum+=v; if (sum>=target) break; }
        }
      }
      const diff = Math.abs(target-sum);
      if (diff<best.diff){ best={diff,set:[...chosen]}; if (!diff) break; }
    }
    return best.set.length? best:null;
  }

  /* ========= PARECIDOS 1:1 ========= */
  const relErr = (a,b)=> (a>0 && isFinite(a) && isFinite(b)) ? Math.abs(a-b)/a : Infinity;

  function findNearestByMetric(base, metric){
    const a = valueForCountryByMetric(base, metric);
    if (a==null) return null;
    let best=null, bestErr=Infinity;
    for (const c of allCountries){
      if (c.iso3===base.iso3) continue;
      const b = valueForCountryByMetric(c, metric);
      if (b==null) continue;
      const e = relErr(a,b);
      if (e<bestErr){ best=c; bestErr=e; }
    }
    return best ? { country: best, err: bestErr } : null;
  }

  function combinedScore(base, cand, weights=WEIGHTS_DEFAULT){
    const parts=[];
    if (base.pop!=null && cand.pop!=null) parts.push(weights.pop * relErr(base.pop, cand.pop));
    if (base.gdp!=null && cand.gdp!=null) parts.push(weights.gdp * relErr(base.gdp, cand.gdp));
    if (base.gdp_pc!=null && cand.gdp_pc!=null) parts.push(weights.gdp_pc * relErr(base.gdp_pc, cand.gdp_pc));
    if (!parts.length) return Infinity;
    const weightUsed = ( (base.pop!=null && cand.pop!=null ? weights.pop : 0)
                       + (base.gdp!=null && cand.gdp!=null ? weights.gdp : 0)
                       + (base.gdp_pc!=null && cand.gdp_pc!=null ? weights.gdp_pc : 0) ) || 1;
    return parts.reduce((a,b)=>a+b,0) / weightUsed;
  }

  function findNearestCombined(base, weights=WEIGHTS_DEFAULT){
    let best=null, bestScore=Infinity;
    for (const cand of allCountries){
      if (cand.iso3===base.iso3) continue;
      const s = combinedScore(base, cand, weights);
      if (s<bestScore){ best=cand; bestScore=s; }
    }
    return best ? { country: best, score: bestScore } : null;
  }

  function topKCombined(base, k=5, weights=WEIGHTS_DEFAULT){
    const arr = [];
    for (const cand of allCountries){
      if (cand.iso3===base.iso3) continue;
      const s = combinedScore(base, cand, weights);
      if (isFinite(s)) arr.push({country:cand, score:s});
    }
    return arr.sort((a,b)=>a.score-b.score).slice(0,k);
  }

  /* ========= COLOREO ========= */
  const capColor = f => {
    const iso = (f.properties?.iso3||'').toUpperCase();
    if (iso && iso===selectedISO3) return '#80ffdb'; // seleccionado
    if (mode==='equiv'){
      if (equivalentsISO3.has(iso))  return '#ffd166'; // equivalentes suma
    }else{
      if (iso && iso===nearestCombinedISO3) return '#ffd166'; // m√°s parecido combinado
    }
    return 'rgba(107,114,128,0.65)';
  };
  const sideColor = ()=>'rgba(42,61,102,0.9)';
  const altitude  = f => {
    const iso = (f.properties?.iso3||'').toUpperCase();
    if (iso && iso===selectedISO3) return 0.025;
    if (mode==='equiv'){
      if (equivalentsISO3.has(iso)) return 0.016;
    }else{
      if (iso && iso===nearestCombinedISO3) return 0.016;
    }
    return 0.004;
  };
  function refreshPolygons(){
    globe
      .polygonCapColor(capColor)
      .polygonSideColor(sideColor)
      .polygonAltitude(altitude)
      .polygonsTransitionDuration(400)
      .polygonsData([...features]);
  }

  /* ========= INTERFAZ DIN√ÅMICA ========= */
  function updateInfoLabelsForMode(){
    if (mode==='equiv'){
      $('hintText').textContent = 'Lista de pa√≠ses equivalentes seg√∫n la m√©trica elegida.';
      $('labelSum').textContent = 'Suma equivalente';
      $('labelDiff').textContent = 'Diferencia';
      $('legendModeLabel').textContent = 'Equivalentes';
    }else{
      $('hintText').textContent = 'Pa√≠s m√°s parecido (combinado y por cada m√©trica).';
      $('labelSum').textContent = 'M√°s parecido (combinado)';
      $('labelDiff').textContent = 'Score (‚Üì es mejor)';
      $('legendModeLabel').textContent = 'M√°s parecido';
    }
  }

  function updateMetricAvailability(){
    // En Equivalencias NO tiene sentido usar PIB per c√°pita, lo deshabilitamos:
    const optGpc = [...metricSelect.options].find(o=>o.value==='gdp_pc');
    if (!optGpc) return;
    if (mode==='equiv'){
      optGpc.disabled = true;
      if (metricSelect.value==='gdp_pc'){
        metricSelect.value = 'pop'; // cambiamos autom√°ticamente a Poblaci√≥n
        $('labelTarget').textContent = labelForMetric('pop');
      }
    }else{
      optGpc.disabled = false;
    }
  }

  /* ========= INTERACCI√ìN ========= */
  function onPickCountry(f){
    const iso = (f.properties?.iso3||'').toUpperCase();
    const rec = allCountries.find(c=>c.iso3===iso);
    const metric = metricSelect.value; // 'pop' | 'gdp' | 'gdp_pc'
    const access = (c)=> valueForCountryByMetric(c, metric);
    const fmtVal = (v)=> formatByMetric(metric, v);

    if(!rec){
      setStatus('Sin datos del pa√≠s seleccionado');
      return;
    }
    selectedISO3 = iso;

    $('labelTarget').textContent = labelForMetric(metric);
    $('selName').textContent = rec.name;
    $('selVal').textContent  = access(rec)!=null ? fmtVal(access(rec)) : '‚Äî';

    if (mode==='equiv'){
      // === MODO EQUIVALENCIAS (suma) ===
      const target = access(rec);
      if(target==null){
        setStatus('Sin dato para la m√©trica elegida');
        $('countriesList').innerHTML = `<div class="item"><span class="muted">No hay datos suficientes para esta m√©trica.</span></div>`;
        refreshPolygons();
        return;
      }

      const pool = allCountries
        .filter(c=>c.iso3!==iso && access(c)!=null && isFinite(access(c)))
        .sort((a,b)=> access(b)-access(a));

      const res = findApproxCombination(pool, target, {tries:350, tolerance:0.02, accessFn:access});

      equivalentsISO3.clear();
      nearestCombinedISO3 = null;
      let sum = 0;
      if (res){
        for (const p of res.set){ equivalentsISO3.add(p.iso3); sum+=access(p); }
      }

      $('sumVal').textContent  = res? fmtVal(sum) : '‚Äî';
      $('diffVal').textContent = res? fmtVal(Math.abs(target-sum)) : '‚Äî';

      $('countriesList').innerHTML = res
        ? [`<div class="section">Equivalentes</div>`,
           ...res.set.map(p=>`<div class="item"><strong>${p.name}</strong><span>${fmtVal(access(p))}</span></div>`)]
            .join('')
        : `<div class="item"><span class="muted">No hay pa√≠ses equivalentes listados</span></div>`;

    } else {
      // === MODO PARECIDOS 1:1 ===
      equivalentsISO3.clear();

      // Nearest por m√©trica
      const nPop = findNearestByMetric(rec,'pop');
      const nGdp = findNearestByMetric(rec,'gdp');
      const nGpc = findNearestByMetric(rec,'gdp_pc');
      const nComb = findNearestCombined(rec, WEIGHTS_DEFAULT);
      nearestCombinedISO3 = nComb?.country?.iso3 || null;

      // Cabecera
      $('sumVal').textContent = nComb ? `${nComb.country.name}` : '‚Äî';
      $('diffVal').textContent = nComb && isFinite(nComb.score) ? `${(nComb.score*100).toFixed(2)}%` : '‚Äî';

      // Top 5 combinados (excluyendo el mejor para no duplicar)
      let top5 = topKCombined(rec, 6, WEIGHTS_DEFAULT); // pedimos 6 por si el primero es el mejor
      if (nComb){
        top5 = top5.filter(x => x.country.iso3 !== nComb.country.iso3).slice(0,5);
      }else{
        top5 = top5.slice(0,5);
      }

      const block = [];
      block.push(`<div class="section">M√°s parecido (combinado)</div>`);
      if (nComb){
        block.push(`<div class="item"><strong>${nComb.country.name}</strong><span class="tag">${(nComb.score*100).toFixed(2)}%</span></div>`);
      }else{
        block.push(`<div class="item"><span class="muted">‚Äî</span></div>`);
      }

      block.push(`<div class="section">Por m√©trica</div>`);
      block.push(`<div class="item"><strong>Poblaci√≥n</strong><span class="tag">${nPop? (nPop.country.name+' ¬∑ '+(nPop.err*100).toFixed(2)+'%') : '‚Äî'}</span></div>`);
      block.push(`<div class="item"><strong>PIB</strong><span class="tag">${nGdp? (nGdp.country.name+' ¬∑ '+(nGdp.err*100).toFixed(2)+'%') : '‚Äî'}</span></div>`);
      block.push(`<div class="item"><strong>PIB per c√°pita</strong><span class="tag">${nGpc? (nGpc.country.name+' ¬∑ '+(nGpc.err*100).toFixed(2)+'%') : '‚Äî'}</span></div>`);

      block.push(`<div class="section">Otros similares (Top 5 combinados)</div>`);
      for (const r of top5){
        block.push(`<div class="item"><span>${r.country.name}</span><span class="tag">${(r.score*100).toFixed(2)}%</span></div>`);
      }

      $('countriesList').innerHTML = block.join('');
    }

    refreshPolygons();
    const c = centroidOfFeature(f);
    globe.pointOfView({ lat:c.lat, lng:c.lng, altitude:1.7 }, 1200);
    setStatus('Listo');
  }

  function centroidOfFeature(f){
    const g = f.geometry;
    const rings = g.type==='Polygon' ? [g.coordinates] : g.coordinates;
    let sl=0, sg=0, n=0;
    rings.forEach(poly=>poly[0].forEach(([lng,lat])=>{ sl+=lat; sg+=lng; n++; }));
    return {lat: sl/n, lng: sg/n};
  }

  /* ========= INICIALIZACI√ìN ========= */
  async function main(){
    try{
      setStatus('Cargando datos‚Ä¶');
      const [geo, popRes] = await Promise.all([loadWorldGeo(), loadPopulation()]);
      features = geo;

      await loadEconomics();

      globe = Globe()(document.getElementById('globe'))
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
        .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
        .polygonsData(features)
        .polygonCapColor(capColor)
        .polygonSideColor(sideColor)
        .polygonAltitude(altitude)
        .polygonStrokeColor(()=> '#0b1022')
        .onPolygonClick(onPickCountry)
        .onPolygonHover(d=> document.body.style.cursor = d ? 'pointer' : 'grab');

      globe.renderer().setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

      globe.controls().autoRotate = true;
      globe.controls().autoRotateSpeed = 0.7;
      globe.controls().minDistance = 180;
      globe.controls().maxDistance = 600;

      function resizeGlobe(){
        const wrap = document.getElementById('globeWrap');
        const {width, height} = wrap.getBoundingClientRect();
        globe.width(width);
        globe.height(height);
        globe.renderer().setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
      }
      const ro = new ResizeObserver(resizeGlobe);
      ro.observe(document.getElementById('globeWrap'));
      window.addEventListener('orientationchange', ()=>setTimeout(resizeGlobe, 250));
      setTimeout(resizeGlobe, 0);

      updateInfoLabelsForMode();
      updateMetricAvailability();

      setStatus(popRes.source==='api' ? 'Datos cargados (API poblaci√≥n)' : 'Datos cargados');
    }catch(err){
      console.error(err);
      setStatus('Error cargando datos');
    }
  }
  main();

  // Cambio de m√©trica
  metricSelect.addEventListener('change', ()=>{
    $('labelTarget').textContent = labelForMetric(metricSelect.value);
    if (selectedISO3){
      const f = features.find(ft=> (ft.properties?.iso3||'').toUpperCase()===selectedISO3);
      if (f) onPickCountry(f);
    }
  });

  // Toggle de modo
  $('btnModeEq').addEventListener('click', ()=>{
    mode='equiv';
    $('btnModeEq').classList.add('active');
    $('btnModeNearest').classList.remove('active');
    updateInfoLabelsForMode();
    updateMetricAvailability();
    if (selectedISO3){
      const f = features.find(ft=> (ft.properties?.iso3||'').toUpperCase()===selectedISO3);
      if (f) onPickCountry(f);
    }
  });
  $('btnModeNearest').addEventListener('click', ()=>{
    mode='nearest';
    $('btnModeNearest').classList.add('active');
    $('btnModeEq').classList.remove('active');
    updateInfoLabelsForMode();
    updateMetricAvailability();
    if (selectedISO3){
      const f = features.find(ft=> (ft.properties?.iso3||'').toUpperCase()===selectedISO3);
      if (f) onPickCountry(f);
    }
  });

  /* ========= DESCARGA JSON ========= */
  $('btnDownload').addEventListener('click', ()=>{
    const payload = allCountries.slice().sort((a,b)=> a.name.localeCompare(b.name));
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
    const a = document.createElement('a'); a.href=dataStr; a.download='paises_pop_gdp.json';
    document.body.appendChild(a); a.click(); a.remove();
  });
</script>
</body>
</html>
